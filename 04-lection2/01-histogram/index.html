<!DOCTYPE html>
<!-- Страница с гистограммой -->
<html lang="ru">

<head>
  <link rel="stylesheet" href="../../assets/css/main.css">
  <link rel="stylesheet" href="./histogram.css">
  <script src="../../assets/js/utils.js"></script>
  <title>Skeleton</title>
  <style>
    body { padding: var(--sp-64); }

    .presentation {
      display: grid;
      gap: 1rem;
    }
  </style>
</head>

<body class="__dev-grid _off">
  <div class="presentation">
    <!-- Как в макете: -->
    <div class="histogram">
      <div class="histogram__info">
        <label class="histogram__label">Total orders</label>
        <p class="histogram__value">50254</p>
        <button class="histogram__action">View all</button>
      </div>
      <div class="histogram__chart">
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 20%"></div>
        <div class="histogram__column" style="height: 30%"></div>
        <div class="histogram__column" style="height: 40%"></div>
        <div class="histogram__column" style="height: 11%"></div>
        <div class="histogram__column" style="height: 14%"></div>
        <div class="histogram__column" style="height: 16%"></div>
        <div class="histogram__column" style="height: 18%"></div>
        <div class="histogram__column" style="height: 20%"></div>
        <div class="histogram__column" style="height: 40%"></div>
        <div class="histogram__column" style="height: 60%"></div>
        <div class="histogram__column" style="height: 80%"></div>
        <div class="histogram__column" style="height: 22%"></div>
        <div class="histogram__column" style="height: 24%"></div>
        <div class="histogram__column" style="height: 26%"></div>
        <div class="histogram__column" style="height: 28%"></div>
        <div class="histogram__column" style="height: 30%"></div>
        <div class="histogram__column" style="height: 40%"></div>
        <div class="histogram__column" style="height: 50%"></div>
        <div class="histogram__column" style="height: 60%"></div>
        <div class="histogram__column" style="height: 33%"></div>
        <div class="histogram__column" style="height: 36%"></div>
        <div class="histogram__column" style="height: 39%"></div>
        <div class="histogram__column" style="height: 41%"></div>
        <div class="histogram__column" style="height: 12%"></div>
        <div class="histogram__column" style="height: 16%"></div>
        <div class="histogram__column" style="height: 18%"></div>
        <div class="histogram__column" style="height: 81%"></div>
        <div class="histogram__column" style="height: 61%"></div>
        <div class="histogram__column" style="height: 21%"></div>
      </div>
    </div>

    <!--
    /* А что если значений будет не так много?
     * Тест модификатора .histogram__chart_alt
     * Хотелось, что бы модификатор был один на общем контейнере и дочерние элементы поменяли цвет.
     * В тоже время для одного из элементов внутри был добавлен еще модификатор .histogram__column_critical
     */
        -->
    <div class="histogram">
      <div class="histogram__info">
        <label class="histogram__label">Total orders</label>
        <p class="histogram__value">502</p>
        <button class="histogram__action">View all</button>
      </div>
      <div class="histogram__chart histogram__chart_alt">
        <div class="histogram__column histogram__column_critical" style="height: 10%"></div>
        <div class="histogram__column" style="height: 20%"></div>
        <div class="histogram__column" style="height: 30%"></div>
        <div class="histogram__column" style="height: 50%"></div>
        <div class="histogram__column" style="height: 80%"></div>
        <div class="histogram__column" style="height: 100%"></div>
        <div class="histogram__column" style="height: 80%"></div>
        <div class="histogram__column" style="height: 50%"></div>
      </div>
    </div>
    <!--
    /* А что если значений будет мало?
     * Тест модификатора .histogram__column_critical
     */
    -->
    <div class="histogram">
      <div class="histogram__info">
        <label class="histogram__label">Total orders</label>
        <p class="histogram__value">50</p>
        <button class="histogram__action">View all</button>
      </div>
      <div class="histogram__chart">
        <div class="histogram__column" style="height: 33%"></div>
        <div class="histogram__column histogram__column_critical" style="height: 67%"></div>
      </div>
    </div>

    <!--
      /* А что если значений будет очень много?
      * Если сжать экран, то гистограмма поедет влево, а не в право.
      * оставляя предположительно актуальные значения всегда в видимой области справа.
      */
    -->
    <div class="histogram" animated>
      <div class="histogram__info">
        <label class="histogram__label">Total orders</label>
        <p class="histogram__value">5025450254</p>
        <button class="histogram__action">View all</button>
      </div>
      <div class="histogram__chart">
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 30%"></div>
        <div class="histogram__column" style="height: 40%"></div>
        <div class="histogram__column" style="height: 11%"></div>
        <div class="histogram__column" style="height: 14%"></div>
        <div class="histogram__column" style="height: 16%"></div>
        <div class="histogram__column" style="height: 18%"></div>
        <div class="histogram__column" style="height: 20%"></div>
        <div class="histogram__column" style="height: 40%"></div>
        <div class="histogram__column" style="height: 60%"></div>
        <div class="histogram__column" style="height: 80%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 61%"></div>
        <div class="histogram__column" style="height: 21%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 20%"></div>
        <div class="histogram__column" style="height: 30%"></div>
        <div class="histogram__column" style="height: 40%"></div>
        <div class="histogram__column" style="height: 11%"></div>
        <div class="histogram__column" style="height: 14%"></div>
        <div class="histogram__column" style="height: 16%"></div>
        <div class="histogram__column" style="height: 18%"></div>
        <div class="histogram__column" style="height: 20%"></div>
        <div class="histogram__column" style="height: 40%"></div>
        <div class="histogram__column" style="height: 60%"></div>
        <div class="histogram__column" style="height: 80%"></div>
        <div class="histogram__column" style="height: 22%"></div>
        <div class="histogram__column" style="height: 24%"></div>
        <div class="histogram__column" style="height: 26%"></div>
        <div class="histogram__column" style="height: 28%"></div>
        <div class="histogram__column" style="height: 30%"></div>
        <div class="histogram__column" style="height: 40%"></div>
        <div class="histogram__column" style="height: 50%"></div>
        <div class="histogram__column" style="height: 60%"></div>
        <div class="histogram__column" style="height: 33%"></div>
        <div class="histogram__column" style="height: 36%"></div>
        <div class="histogram__column" style="height: 39%"></div>
        <div class="histogram__column" style="height: 41%"></div>
        <div class="histogram__column" style="height: 12%"></div>
        <div class="histogram__column" style="height: 16%"></div>
        <div class="histogram__column" style="height: 18%"></div>
        <div class="histogram__column" style="height: 81%"></div>
        <div class="histogram__column" style="height: 61%"></div>
        <div class="histogram__column" style="height: 21%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 20%"></div>
        <div class="histogram__column" style="height: 30%"></div>
        <div class="histogram__column" style="height: 40%"></div>
        <div class="histogram__column" style="height: 11%"></div>
        <div class="histogram__column" style="height: 14%"></div>
        <div class="histogram__column" style="height: 16%"></div>
        <div class="histogram__column" style="height: 18%"></div>
        <div class="histogram__column" style="height: 20%"></div>
        <div class="histogram__column" style="height: 40%"></div>
        <div class="histogram__column" style="height: 60%"></div>
        <div class="histogram__column" style="height: 80%"></div>
        <div class="histogram__column" style="height: 22%"></div>
        <div class="histogram__column" style="height: 24%"></div>
        <div class="histogram__column" style="height: 26%"></div>
        <div class="histogram__column" style="height: 28%"></div>
        <div class="histogram__column" style="height: 30%"></div>
        <div class="histogram__column" style="height: 40%"></div>
        <div class="histogram__column" style="height: 50%"></div>
        <div class="histogram__column" style="height: 60%"></div>
        <div class="histogram__column" style="height: 33%"></div>
        <div class="histogram__column" style="height: 36%"></div>
        <div class="histogram__column" style="height: 39%"></div>
        <div class="histogram__column" style="height: 41%"></div>
        <div class="histogram__column" style="height: 12%"></div>
        <div class="histogram__column" style="height: 16%"></div>
        <div class="histogram__column" style="height: 18%"></div>
        <div class="histogram__column" style="height: 81%"></div>
        <div class="histogram__column" style="height: 61%"></div>
        <div class="histogram__column" style="height: 21%"></div>
        <div class="histogram__column" style="height: 10%"></div>
        <div class="histogram__column" style="height: 20%"></div>
        <div class="histogram__column" style="height: 30%"></div>
        <div class="histogram__column" style="height: 40%"></div>
        <div class="histogram__column" style="height: 11%"></div>
        <div class="histogram__column" style="height: 14%"></div>
        <div class="histogram__column" style="height: 16%"></div>
        <div class="histogram__column" style="height: 18%"></div>
        <div class="histogram__column" style="height: 20%"></div>
        <div class="histogram__column" style="height: 40%"></div>
        <div class="histogram__column" style="height: 60%"></div>
        <div class="histogram__column" style="height: 80%"></div>
        <div class="histogram__column" style="height: 22%"></div>
        <div class="histogram__column" style="height: 24%"></div>
        <div class="histogram__column" style="height: 26%"></div>
        <div class="histogram__column" style="height: 28%"></div>
        <div class="histogram__column" style="height: 30%"></div>
        <div class="histogram__column" style="height: 40%"></div>
        <div class="histogram__column" style="height: 50%"></div>
        <div class="histogram__column" style="height: 60%"></div>
        <div class="histogram__column" style="height: 33%"></div>
        <div class="histogram__column" style="height: 36%"></div>
        <div class="histogram__column" style="height: 39%"></div>
        <div class="histogram__column" style="height: 41%"></div>
        <div class="histogram__column" style="height: 12%"></div>
        <div class="histogram__column" style="height: 16%"></div>
        <div class="histogram__column" style="height: 18%"></div>
        <div class="histogram__column" style="height: 81%"></div>
        <div class="histogram__column" style="height: 61%"></div>
        <div class="histogram__column" style="height: 21%"></div>
      </div>
    </div>

  </div>
  <script>
    (function() {
      "use strict";
      const {
        qs, cl, insert, px, int, stl,
        getAttr, setAttr, remAttr,
        getCmpStl, rndMinMaxInt: rrr,
      } = window.utils;
      const { values } = Object;
      const getIntHeight = el => int(stl(el, 'height'));
      const setRndHeight = el => stl(el, 'height', `${rrr(1, 100)}%`);
      class Histogram {
        /* elements*/
        elRoot = null;
        elValue = null;
        elChart = null;
        elButton = null;
        elValueTmp = null;
        elColumns = [];

        /* props */
        timerOmg = null;
        timer = null;
        timeout = rrr(250, 1250);

        total = 0;

        static elements = [];

        constructor(el) {
          this.elRoot = el;
          this.elValue = qs('.histogram__value', el);
          this.elButton = qs('.histogram__action', el);
          this.elChart = qs('.histogram__chart', el);
          this.elColumns = [...qs('.histogram__column', this.elChart, 'querySelectorAll')];

          this.elValueTmp = document.createElement('p');

          cl
            (this.elValueTmp, 'histogram__value', 'add')
            (this.elValueTmp, 'histogram__value_ghost', 'add');

          insert(this.elValueTmp, this.elValue.parentNode);
          this.elButton.addEventListener('click', _ => this.omg());
          this.loop();
        }

        isRun() { return !(getAttr(this.elRoot, 'animated') === null); }
        party() {
          this.elColumns.forEach(el => {
            setRndHeight(el);
            if (getIntHeight(el) > rrr(85, 99)) cl(el, 'histogram__column_critical', 'add');
            else if (getIntHeight(el) < rrr(1, 10)) cl(el, 'histogram__column_critical', 'add');
            else cl(el, 'histogram__column_critical', 'remove');
          });
        }
        omg() {
          clearTimeout(this.timerOmg);
          let [self, counter, t, maxTimer] = [this, 0, rrr(120, 450), rrr(3, 9)];
          const process = _ => {
            t = rrr(t, t * 2);
            if (++counter < maxTimer) {
              stl(self.elChart, 'overflow', 'visible');
              self.elColumns
              .forEach((el, i) => stl(el, 'transform',`rotate(${i % 2 === 0 ? rrr(0, 360) : 0}deg)`));
            } else {
              stl(self.elChart, 'overflow', 'hidden');
              self.elColumns
              .forEach(el => stl(el, 'transform', 'rotate(0deg)'));
              return clearTimeout(self.timerOmg);
            }
            self.timerOmg = setTimeout(process, t);
          };
          process();
        }

        updateCount() { this.elValue.innerText = this.total; }
        updateGhost() { this.elValueTmp.innerText = this.total; }

        count() {
          let aT = 150
          this.total = this.elColumns.reduce((sum, el) => (sum + getIntHeight(el)), 0) * rrr(10, 1000);

          cl(this.elValue, 'histogram__value_hide', 'add');
          this.updateGhost();
          remAttr(this.elValueTmp, 'style');
          /* 💩 */
          setTimeout(_ => {
            cl(this.elValueTmp, 'histogram__value_ghostAppear', 'add');
            /* 💩💩 */
            setTimeout(_ => {
              setAttr(this.elValue, 'style', 'visibility: hidden');
              cl(this.elValue, 'histogram__value_hide', 'remove');
              /* 💩💩💩 */
              setTimeout(_ => {
                this.updateCount();
                cl(this.elValueTmp, 'histogram__value_ghostAppear', 'remove');
                setAttr(this.elValueTmp, 'style', 'visibility: hidden');
                remAttr(this.elValue, 'style');
              }, aT * 4);
            }, aT * 4);
          }, aT);
        }

        loop() {
          let self = this;
          const process = _ => {
            if (!(self.isRun())) return clearTimeout(self.timer);
            self.party();
            self.count();
            self.timeout = rrr(600, 6000);
            self.timer = setTimeout(process, self.timeout);
          };
          process();
        }

        /* static methods */
        static init({ selector, ctx = null }) {
          [...qs(selector, ctx, 'querySelectorAll')]
          .forEach(el => this.addElement(new this(el)));
          return this;
        }

        static log() {
          console.log(this.elements);
          return this;
        }

        static addElement(el) {
          console.log('addElement', el);
          if (!el) return false;
          this.elements.push(el);
          return this;
        }
      };

      Histogram
        .init({ selector: '.histogram[animated]' })
        .log();
    })();
  </script>
</body>
</html>
